<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Present Continuous Chat Game</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400..700&family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #ffffff;
      --ink: #1a1a1a;
      --card: #fff;
      --accent: #6d5efc;
      --accent-2: #22c55e;
      --accent-3: #f59e0b;
      --shadow: 0 10px 25px rgba(0,0,0,.08);
      --radius: 26px;
    }
    html,body{height:100%}
    body{ margin:0; background: var(--bg); color: var(--ink); font-family: "Nunito", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .screen{ min-height:100vh; display:flex; align-items:center; justify-content:center; padding: clamp(12px, 2.5vw, 28px); }
    .card{ width:min(860px, 100%); background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); padding: clamp(22px, 4vw, 44px); border: 4px solid #1f2937; position: relative; overflow: hidden; isolation:isolate; }
    /* full-bleed mode for scenes 2 & 3: image fills card, only outer page padding remains */
    .card.full-bleed{ padding:0; background:transparent; border:none; box-shadow:none; }
    .card.full-bleed::before, .card.full-bleed::after{ display:none; }
    .card::before, .card::after{ content:""; position:absolute; inset:auto auto -40px -40px; width:140px; height:140px; background: radial-gradient( circle at 30% 30%, var(--accent) 0 35%, transparent 36% ), radial-gradient( circle at 70% 70%, var(--accent-2) 0 35%, transparent 36% ), radial-gradient( circle at 75% 25%, var(--accent-3) 0 28%, transparent 29% ); opacity:.25; filter: blur(1px); transform: rotate(-12deg); z-index:-1; }
    .card::after{ inset:-40px -40px auto auto; transform: rotate(18deg); }

    .title{ font-family: "Fredoka", "Nunito", system-ui, sans-serif; font-size: clamp(28px, 4.6vw, 48px); line-height: 1.1; margin: 0 0 12px; letter-spacing: 0.5px; text-shadow: 0 2px 0 #ffffff, 0 4px 0 rgba(0,0,0,.1); }
    .subtitle{ font-size: clamp(16px, 2.1vw, 20px); margin: 0 0 22px; }
    .cta{ display:inline-block; border:none; cursor:pointer; font-family: "Fredoka", "Nunito", system-ui, sans-serif; font-weight: 800; letter-spacing: .4px; font-size: clamp(18px, 2.6vw, 22px); padding: 14px 26px; border-radius: 18px; background: linear-gradient(180deg, #ffd34d, #f59e0b); color: #111827; box-shadow: 0 8px 0 #111827, 0 12px 24px rgba(0,0,0,.15); transition: transform .12s ease, box-shadow .12s ease, filter .12s ease; }
    .cta:hover{ transform: translateY(-2px); filter: brightness(1.03); }
    .cta:active{ transform: translateY(2px); box-shadow: 0 4px 0 #111827; }

    /* Chat UI */
    .chat-wrap{ display:none; }
    .chat{ display:flex; flex-direction:column; gap:12px; height: auto; min-height: 260px; background:#f1f5ff; border-radius: 18px; padding: 14px; overflow: visible; border:2px solid #1f2937; word-wrap: break-word; overflow-wrap: anywhere; white-space: normal; }
    .chat-header{ background:#111827; color:#fff; border:2px solid #1f2937; border-radius:14px; padding:8px 12px; font-weight:800; display:flex; align-items:center; gap:8px; }
    .bubble{ max-width: 78%; padding: 12px 14px; border-radius: 18px; line-height: 1.35; box-shadow: var(--shadow);} 
    .friend{ align-self:flex-start; background:#fff; border:2px solid #1f2937; position:relative; }
    .friend::after{ content:""; position:absolute; left:-8px; top:12px; width:0; height:0; border-top:8px solid transparent; border-bottom:8px solid transparent; border-right:8px solid #fff; }
    .me{ align-self:flex-end; background:#dcfce7; border:2px solid #166534; position:relative; }
    .me::after{ content:""; position:absolute; right:-8px; top:12px; width:0; height:0; border-top:8px solid transparent; border-bottom:8px solid transparent; border-left:8px solid #dcfce7; }
    .hint{ font-size:14px; opacity:.8; }

    .callout{ background:#eef2ff; border:2px solid #312e81; border-radius:16px; padding:14px 16px; margin:0 0 24px; font-weight:700; }
    .callout em{ font-style:normal; font-weight:800; }

    /* ===== Scene 2 ===== */
    .scene2-wrap{ display:none; margin-top: 8px; }
    .bg-stage{ position: relative; width: 100%; min-height: 85vh; aspect-ratio: auto; border-radius: 18px; overflow: hidden; background-size: contain; background-repeat: no-repeat; background-position: center; margin: clamp(8px, 2vw, 20px); }
    .overlay-instruction{ position: absolute; left: 14px; bottom: 14px; z-index: 5; display: inline-flex; align-items: center; gap: 10px; padding: 12px 18px; border-radius: 18px; font-family: "Fredoka", "Nunito", system-ui, sans-serif; font-weight: 800; letter-spacing: .4px; font-size: clamp(16px, 2.2vw, 20px); background: linear-gradient(180deg, #ffd34d, #f59e0b); color: #111827; box-shadow: 0 8px 0 #111827, 0 12px 24px rgba(0,0,0,.15); }
    .overlay-instruction.pulse{ animation: throb 1s ease-in-out infinite; }
    @keyframes throb { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.04); } }
    .screen-hotspot{ position: absolute; inset: 18% 28% 28% 28%; cursor: pointer; }

    .card.no-outline{ border: none; }

    /* ===== Scene 3 ===== */
    .scene3-wrap{ display:none; margin-top:8px; }
    .bg-stage3{ position: relative; width: 100%; min-height: 88vh; aspect-ratio: auto; border-radius: 18px; overflow: hidden; background-size: contain; background-repeat: no-repeat; background-position: center; margin: clamp(8px, 2vw, 20px); }
    .floating-chat{ position:absolute; left: 14px; top: 20px; bottom: 170px; width: min(520px, 56%); z-index: 6; display:flex; flex-direction:column; gap:12px; overflow:visible; }
    .calendar-pane{ position:absolute; right:24px; top:28px; bottom:170px; width:min(340px, 36%); z-index:7; background:#fff; border-radius:20px; box-shadow: var(--shadow); border: 3px solid #1f2937; padding:14px 16px; overflow:visible; }
    .calendar-title{ font-family:"Fredoka","Nunito",system-ui,sans-serif; font-weight:800; margin:0 0 8px; font-size: clamp(18px,2.4vw,22px); }
    .calendar-grid{ display:grid; grid-template-columns:1fr; gap:8px; }
    .cal-card{ background:#eef2ff; border:2px solid #312e81; border-radius:14px; padding:10px 12px; font-weight:800; cursor:pointer; }

    @media (max-width: 820px){ .floating-chat{ width: 62%; } .calendar-pane{ width: 36%; } }
    @media (max-width: 640px){ .bg-stage3{ aspect-ratio:auto; min-height: 520px; } .floating-chat{ position: absolute; left: 12px; right: 12px; width:auto; } .calendar-pane{ position:absolute; right:12px; left:12px; top:auto; bottom:12px; width:auto; } }

    /* Modal */
    .modal{ position: fixed; inset:0; background: rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:50; }
    .modal.open{ display:flex; }
    .modal-card{ width:min(460px, 92vw); background:#fff; border:4px solid #1f2937; border-radius:22px; box-shadow: var(--shadow); padding:18px 20px; }
    .modal-title{ font-family:"Fredoka","Nunito",system-ui,sans-serif; font-size: clamp(18px, 2.6vw, 24px); margin:0 0 8px; }
    .modal-actions{ display:flex; justify-content:flex-end; margin-top:12px; }
    .btn{ display:inline-block; border:none; cursor:pointer; font-family:"Fredoka","Nunito",system-ui,sans-serif; font-weight:800; padding:10px 16px; border-radius:14px; box-shadow: 0 6px 0 #111827; background: linear-gradient(180deg, #ffd34d, #f59e0b); }

    /* Chat composer (typing) */
    .composer-row{ display:flex; align-items:center; gap:10px; margin-top:8px; }
    .input{ flex:1; height:48px; border:3px solid #1f2937; border-radius:16px; padding:10px 12px; font-family:"Nunito",system-ui,sans-serif; font-size:16px; box-shadow: 0 4px 0 #1f2937; }
    .send{ border:none; padding:12px 18px; border-radius:14px; cursor: pointer; background: linear-gradient(180deg, #60a5fa, #2563eb); color:#fff; font-weight:800; box-shadow:0 6px 0 #1e3a8a; align-self:flex-end; }
    .send:disabled{ cursor:default; filter: saturate(.2) brightness(.95); box-shadow:0 6px 0 #94a3b8; }
  </style>
</head>
<body>
  <main class="screen">
    <section class="card" id="scene">
      <h1 class="title">Chat & Practice: Present Continuous</h1>
      <p class="subtitle">In this miniâ€‘game, youâ€™ll <strong>chat with a friendly partner</strong> and practice the <em>present continuous</em> (am/are/is + verbâ€‘ing).</p>
      <div class="callout">Practice the <em>present continuous</em> by chatting in real time. Use your knowledge of present continuous to reply to your friend.</div>
      <button class="cta" id="start">â–¶ Start</button>

      <div class="scene2-wrap" id="scene2">
        <div class="bg-stage" id="bgStage" style="background-image:url('https://raw.githubusercontent.com/ik3057823-ops/media/refs/heads/main/bedroom%20(1).png');">
          <div class="screen-hotspot" id="screenHotspot" title="Click the computer screen to start!"></div>
          <div class="overlay-instruction pulse" id="overlayInstruction">ðŸ’¡ Click on the computer screen to start!</div>
        </div>
      </div>

      <div class="scene3-wrap" id="scene3">
        <div class="bg-stage3" id="bgStage3" style="background-image:url('https://raw.githubusercontent.com/ik3057823-ops/media/refs/heads/main/windows.png');">
          <div class="calendar-pane" id="calendarPane" aria-live="polite">
            <h3 class="calendar-title">ðŸ“… This Week</h3>
            <div class="calendar-grid" id="calendarGrid">
              <div class="cal-card" data-day="Monday">Monday</div>
              <div class="cal-card" data-day="Tuesday">Tuesday</div>
              <div class="cal-card" data-day="Wednesday">Wednesday</div>
              <div class="cal-card" data-day="Thursday">Thursday</div>
              <div class="cal-card" data-day="Friday">Friday</div>
              <div class="cal-card" data-day="Saturday">Saturday</div>
              <div class="cal-card" data-day="Sunday">Sunday</div>
            </div>
          </div>
        </div>
      </div>

      <div class="chat-wrap" id="chatWrap">
        <div class="chat-header">ðŸ’¬ Friend â€” online</div>
        <div class="chat" id="chat"></div>
        <div class="composer-row">
            <input class="input" id="textInput" type="text" placeholder="Type your reply..." autocomplete="off" />
            <button class="send" id="sendBtn" disabled>Send</button>
        </div>
      </div>

    </section>

    <div class="modal" id="planModal" aria-modal="true" role="dialog" aria-labelledby="modalTitle">
      <div class="modal-card">
        <h3 class="modal-title" id="modalTitle">Day</h3>
        <p id="modalBody">Plan detailsâ€¦</p>
        <div class="modal-actions"><button class="btn" id="modalClose">Close</button></div>
      </div>
    </div>
  </main>

  <audio id="bgm" loop>
    <source src="https://raw.githubusercontent.com/ik3057823-ops/media/refs/heads/main/daytime-farm-ambience-409990.mp3" type="audio/mpeg">
  </audio>

  <script>
    const startBtn = document.getElementById('start');
    const scene = document.getElementById('scene');
    const chatWrap = document.getElementById('chatWrap');
    const chat = document.getElementById('chat');
    const sendBtn = document.getElementById('sendBtn');
    const textInput = document.getElementById('textInput');

    const scene2 = document.getElementById('scene2');
    const bgStage = document.getElementById('bgStage');
    const hotspot = document.getElementById('screenHotspot');
    const overlayInstruction = document.getElementById('overlayInstruction');
    const scene3 = document.getElementById('scene3');
    const bgStage3 = document.getElementById('bgStage3');
    const bgm = document.getElementById('bgm');

    function show(el){ if(el) el.style.display='block'; }
    function hide(el){ if(el) el.style.display='none'; }

    function addBubble(text, who='friend'){
      const b = document.createElement('div');
      b.className = `bubble ${who}`;
      b.textContent = text;
      chat.appendChild(b);
      chat.scrollTop = chat.scrollHeight;
    }

    const firstQuestion = "Hi! What are you doing on Wednesday?";

    function startGame(){
      // Hide intro content and show image scene
      startBtn.remove();
      document.querySelectorAll('.title, .subtitle, .callout').forEach(el=>{ if(el) el.style.display = 'none'; });
      scene.classList.add('no-outline');
      scene.classList.add('full-bleed');
      show(scene2);
      try {
        bgm.volume = 0.7;
        const p = bgm.play();
        if(p && p.catch){ p.catch(()=>{}); }
      } catch(e) {}
    }
    startBtn.addEventListener('click', startGame);

    function enterScene3(){
      scene.classList.add('full-bleed');
      hide(scene2);
      show(scene3);
      if(chatWrap && !chatWrap.classList.contains('floating-chat')){
        chatWrap.classList.add('floating-chat');
        bgStage3.appendChild(chatWrap);
      }
      show(chatWrap);
      if(chat && chat.children.length===0){ addBubble(firstQuestion, 'friend'); }
      if(overlayInstruction) overlayInstruction.classList.remove('pulse');
      try {
        const p = bgm.play();
        if(p && p.catch){ p.catch(()=>{}); }
      } catch(e) {}
    }
    hotspot.addEventListener('click', enterScene3);
    bgStage.addEventListener('click', enterScene3);

    // ===== Calendar plans & modal =====
    const plans = { Monday: "No plan yet.", Tuesday: "No plan yet.", Wednesday: "going to swimming", Thursday: "No plan yet.", Friday: "studying math", Saturday: "No plan yet.", Sunday: "going to the cinema" };
    const grid = document.getElementById('calendarGrid');
    const modal = document.getElementById('planModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    const modalClose = document.getElementById('modalClose');
    function openPlan(day){ modalTitle.textContent = day; modalBody.textContent = plans[day] || 'No plan yet.'; modal.classList.add('open'); }
    function closeModal(){ modal.classList.remove('open'); }
    if(grid){ grid.addEventListener('click', (e)=>{ const card = e.target.closest('.cal-card'); if(card){ openPlan(card.dataset.day); } }); }
    if(modalClose) modalClose.addEventListener('click', closeModal);
    if(modal) modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });

    // ===== Chat typing logic =====
    function sendMessage(){
      const val = (textInput.value || '').trim();
      if(!val) return;
      addBubble(val, 'me');
      textInput.value='';
      updateSendDisabled();
    }
    function updateSendDisabled(){
      const has = (textInput.value||'').trim().length>0;
      sendBtn.disabled = !has;
    }
    sendBtn.addEventListener('click', sendMessage);
    textInput.addEventListener('input', updateSendDisabled);
    textInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); sendMessage(); }});

    // --- Tests (kept as-is, plus a small extra) ---
    (function chatTests(){
      try{
        const input = document.getElementById('textInput');
        const btn = document.getElementById('sendBtn');
        console.assert(input && btn, 'Chat input or send button missing');
        input.value = 'I am going to swimming.'; input.dispatchEvent(new Event('input'));
        console.assert(btn.disabled === false, 'Send should enable when there is text');
        btn.click();
        const last = chat.lastElementChild?.textContent || '';
        console.assert(last.includes('I am going to swimming.'), 'Message did not send to chat');
      }catch(e){ console.warn('Chat test error:', e); }
    })();

    (function inputEnableDisableTest(){
      try{
        const input = document.getElementById('textInput');
        const btn = document.getElementById('sendBtn');
        input.value=''; input.dispatchEvent(new Event('input'));
        console.assert(btn.disabled === true, 'Send should be disabled for empty input');
        input.value='hello'; input.dispatchEvent(new Event('input'));
        console.assert(btn.disabled === false, 'Send should enable when text present');
      }catch(e){ console.warn('Input enable/disable test error:', e); }
    })();

    (function uiTests(){
      try{
        console.assert(document.getElementById('start'), 'Start button missing');
        console.assert(document.getElementById('scene2'), 'Scene 2 missing');
        console.assert(document.getElementById('scene3'), 'Scene 3 missing');
        const days = Array.from(document.querySelectorAll('#calendarGrid .cal-card')).map(n=>n.textContent.trim());
        console.assert(days.length === 7, 'Expected 7 days in the calendar');
        console.assert(plans['Wednesday']?.toLowerCase().includes('going to swimming'), 'Wednesday plan mismatch');
        console.assert(plans['Friday']?.toLowerCase().includes('studying math'), 'Friday plan mismatch');
        console.assert(plans['Sunday']?.toLowerCase().includes('going to the cinema'), 'Sunday plan mismatch');
      }catch(e){ console.warn('UI test error:', e); }
    })();

    (function layoutTests(){
      try{
        const stage = document.getElementById('bgStage3');
        const chatWrapEl = document.getElementById('chatWrap');
        const cal = document.getElementById('calendarPane');
        if(stage && chatWrapEl && cal){
          const s = stage.getBoundingClientRect();
          const c = chatWrapEl.getBoundingClientRect();
          const k = cal.getBoundingClientRect();
          const within = (a,b)=> a.left>=b.left-2 && a.top>=b.top-2 && a.right<=b.right+2 && a.bottom<=b.bottom+2;
          console.assert(within(c,s), 'Chat panel is overflowing the scene');
          console.assert(within(k,s), 'Calendar panel is overflowing the scene');
        }
      }catch(e){ console.warn('Layout test error:', e); }
    })();

    (function audioElementTests(){
      try{
        const audio = document.getElementById('bgm');
        console.assert(!!audio, 'Background audio element is missing');
        console.assert(typeof audio.play === 'function', 'Audio element does not support play()');
      }catch(e){ console.warn('Audio element test error:', e); }
    })();
  </script>
</body>
</html>
